# 인계 문서 (UTF-8)

본 문서는 차후 세션에서 작업을 이어받기 위한 개요, 현재 상태, 다음 단계, 주의사항, 인계용 프롬프트를 정리합니다. 반드시 이 파일은 UTF-8로 저장/유지해 주세요.

## 목표 요약
- 발주처/금액구간별 적격검사 산출식(경영·시공)을 내장 기본값 + 사용자 오버라이드(JSON)로 관리
- 설정 화면에서 산출식을 사용자가 수정하고, 샘플 값으로 미리보기 가능
- 향후 자동 협정(공동도급) 기능에서 해당 산출식을 활용해 점수 극대화 조합을 제안

## 현재 구현 상태
- 기본값 스키마/데이터
  - `src/shared/formulas.defaults.json`: LH 50억 미만 기준 기본값(경영: 요소합산+신용등급, 시공: 5년실적/기초금액×13, 절삭 규칙 반영)
- 포뮬러 로더(병합)
  - `src/shared/formulas.js`: 내장 기본값 + `userData/formulas.json`(오버라이드) 병합 로더
  - Electron `main.js` IPC: `formulas-load`, `formulas-load-defaults`, `formulas-load-overrides`, `formulas-save-overrides`, `formulas-evaluate`
  - `preload.js`에서 위 IPC를 `window.electronAPI`로 노출
- 평가 엔진(뼈대)
  - `src/shared/evaluator.js`: 경영(요소합산/신용등급 모두 계산 후 최대값 선택), 시공(절삭) 계산 지원
- 설정 화면
  - `src/view/features/settings/pages/SettingsPage.jsx`: 현재 “모달 상세 편집” 이전 상태로 복구됨(에러 제거 목적)
  - 기본값 복원/병합 로딩/미리보기 연결 로직은 이미 IPC로 가능

## 남은 작업(우선순위)
1) 자동협정 기능을 위한 발주처 별 협정 기능 UI 추가 
  일단 LH (한국토지주택공사) 먼저 구현.

  **나누었던 대화를 올리니 참고**
  ```
  제안 워크플로우

Notice 설정: 기초금액, 공종(전기/통신/소방), 지역의무/비율, 팀원 수 범위, 대표사 후보(선택), 커스텀 제약(지분 최솟값/최댓값 등).
후보 풀 구성: 검색 기준으로 후보업체 조회(기존 검색 기능 유지), 필터(지역, 최근 자료 최신, 품질평가 보유 등), 후보 고정/제외 지정.
자동 구성 제안: 제약을 반영해 상위 조합 N개 생성(점수, 지분배분, 근거 데이터 표시). 사용자 편집(추가/삭제/지분 조정).
검증·미리보기: 제안/편집된 조합을 평가엔진에 넣어 점수·세부 파트(부채/유동/영업기간/신용/품질)를 가시화.
내보내기: 엑셀 + 보고서(조합 상세, 참여사 개별 데이터, 평가 근거). 저장소 agreements.json에 시나리오 저장.
데이터/평가 모델

입력(업체 단위): debtRatio(%), currentRatio(%), bizYears, creditGrade, qualityEval(없으면 85), 5년실적, 지분(%), 지역정보.
JV 평가 입력 변환(유연 옵션화):
모드 A(권장/단순): 각 구성요소의 “점수”를 먼저 산출 → 지분 가중 합산(품질처럼) → 합계 점수.
모드 B(대안/엄밀): “지표”를 지분 가중 평균으로 먼저 집계 → 임계표에 한 번 대입해 점수 산출(기관별 정의가 다르면 선택).
품질평가: 기본 85 적용(데이터 없을 때), 모달로 임계표 편집 가능(이미 구현됨).
제약: 지역의무 비율, 팀원 수 범위, 대표사 필수 여부, 단독입찰 가능시 제외, 지분 min/max, 동일 그룹 중복 제한 등(설정에서 입력받아 제안기에 전달).
자동 구성 알고리즘

후보 축소: 지역의무 충족 가능한 지역업체 우선 + 전공종 후보를 점수 상위 K, 최근자료 최신, 품질 상위 등으로 K~L개로 제한.
지분 탐색: 불연속 그리드(예: 1% 또는 0.5%)로 분할. 대표사 고정 시 나머지 지분 분배.
조합 생성:
2~m명 팀 크기 루프 → 후보 조합/지분 그리드 탐색.
제약 위반(지역비율/지분 범위/중복 등) 즉시 가지치기.
상한 추정(heuristic upper bound)로 빔서치/우선순위큐 유지(탐색 폭 B).
점수 계산: 선택한 모드(A/B)로 JV 점수 계산. 세부 파트별 점수도 보관.
성능: K(후보)+B(빔 폭)+그리드 단위로 조절. 초기엔 K≈30, B≈200, 지분 단위 1% 권장. 필요시 greedy 초기해 + 국소탐색(스왑/지분 미세조정)로 미세개선.
UI 설계

Agreements Wizard(신규 화면):
Step 1 설정: 공고정보/제약/목표(점수 극대화/품질 가중 등).
Step 2 후보 풀: 검색 결과에서 체크인/고정/제외, 메타(품질/자료년도/지역).
Step 3 제안: 상위 N 조합(카드/표) + 점수/지분/제약 충족 뱃지. “세부 보기”에서 파트 점수와 근거 노출.
Step 4 확정/내보내기: 엑셀/보고서 다운로드, agreements.json 저장.
편집 UX: 조합 카드에서 구성원 추가/삭제/지분 슬라이더, 즉시 재평가.
IPC/코드 구조 제안

JV 평가 모듈: src/shared/agreements/jvEvaluator.js
evaluateJV(members[], rules, mode) → {score, parts, constraintsOk, notes}
suggestCombos(params) → 상위 조합 N개 반환(제약·빔서치 포함)
IPC: agreements-suggest, agreements-evaluate-jv, agreements-export
프론트:
화면: src/view/features/agreements/pages/AgreementsWizard.jsx
상태: 설정/후보/제안/선택조합; agreements-save로 저장.
기존 검색 연동: 현재 SearchService/IPC 그대로 사용. 후보 풀 구성 시 재사용.
보고서/엑셀

src/shared/agreements/generator.js 확장:
시트: 요약(조합/점수/제약), 구성원 상세(지표, 점수, 지분), 평가 근거(임계표/라운딩), 로그(제약/탐색 파라미터).
파일명 규칙: 협정_공고번호_YYYYMMDD_HHMM.xlsx.
안전장치/UX

제약 유효성: 지분 합 100%, 지역의무 ≥ 요구치, 팀원 수 범위 등 즉시 경고.
데이터 결손: 품질/신용/재무 비는 결측 규칙(기본값/제외)을 사용자 선택으로.
재현성: 시드 고정(탐색 순서/무작위 샘플링 시).
단계적 구축 계획

JV 평가 모듈(A 모드) + 프리뷰 API(evaluateJV)
후보 풀 선택 UI + 간단 greedy 제안(대표사 고정/지역비율만)
빔서치 + 지분 그리드 탐색 확장, 제약 추가
엑셀/보고서, 상태 저장, 복구
B 모드(지표-집계 후 임계) 옵션과 가중치(파트 가중) 도입
이 흐름이면 기존 검색 기능은 그대로 유지되고, 자동협정은 “제안 + 사용자가 최종 편집”하는 형태라 현실 운용에도 맞습니다.
  ```

  ```
  **폼 UI 설계 제안**
- 공종: 전기/통신/소방
- 공고번호, 공고명, 발주처
- 기초금액: 숫자
- 입찰일(선택)


**제약/규칙**
- 지역업체 의무: 사용 여부, 의무 비율(%)
- 팀원 수: 최소/최대(예: 2~3)
- 대표사 고정(선택): 업체명/사업자번호 지정
- 지분 제한: 최소/최대(%), 단위(예: 1% 단위)
- 제외/고정 업체 리스트
- 후보 풀(검색/필터)

**지역(시/도, 시/군/구), 최근자료 최신 여부**
품질평가 기준: 최소 점수(없으면 85 허용 여부)
신용등급/재무 지표 필터(선택)
후보 상한 K(예: 30)


**평가/제안 옵션**
조합 개수 N(예: 50)
탐색 폭/그리드(고급): 빔 폭, 지분 단위(0.5%/1%)
평가 모드: 파트 점수 지분가중(A 권장) vs 지표 집계 후 임계(B 선택)
출력/저장

보고서 옵션: 엑셀 시트 구성, 파일명 규칙
시나리오 저장 이름
다음 단계 제안

AgreementsPage에 위 폼을 Step 1로 추가 → Step 2 후보선택 → Step 3 제안결과 → Step 4 내보내기.
  ```

  ### 나의 최종 제안 (UI)
  ```
  발주처는 고르지않는부분이 좌측메뉴바에 발주처별로 메뉴를 뺄거야
LH, 행안부, 조달청, 한국도로공사 등등 이렇게 발주처 별로 메뉴를 나누고
LH 메뉴 안에서 금액범위를 선택하는거로 생각중이야
LH를고르면 그 안에서 금액범위 50억미만, 50억~100억 이렇게 메뉴를 고르는거지.

### 입력 항목
공종: 전기/통신/소방
공고번호, 공고명
기초금액, 추정가격 (숫자)
공고일 (달력에서 선택)
시공비율시 추정금액 기준 (숫자)
입찰참가자격금액 (이건 사용자가 입력한 추정가격을 그대로 가져다 쓰면돼)
제약/규칙
지역업체 의무: 어디지역, , 최소지역업체 의무비율 (%)
팀원수 : 최대 몇 개사 (1~5)
대표사고정, 지분제한, 제외/고정 업체리스트는 설정메뉴에서 셋팅값에 추가하는걸로 할게

---

### 후보 풀
지역(의무지역이 경기, 강원 이렇게 되어있어서 구체적인 지역은 상관없어 위에서 사용자가 정한 의무지역 안에만 들어오면돼
품질평가 기준: 품질평가점수가 80점 미만이면 0점이고 내가 json에 적은 품질평가 기준을 따르면되는거야
신용등급/재무 지표 필터는 업체를 조회할때 둘 중에 한가지만이라도 만점이라면 상관없어 그러니까 신용등급으로도 계산하고 재무지표로도 계산해야하는거지
후보상한은 좀 더 고려해보고 추가할계

---

평가/제안 옵션과 출력/저장 목록은 이거부터 추가하고 다음에 추가할게
일단 이렇게만 UI 만들어줘

  ```


## 실행/검증 방법
- 개발 실행: `npm run start:dev` (vite + electron 동시 실행)
- 설정 화면 접속: 해시 라우팅 `#/settings`
- 병합/기본값 확인: 설정 화면에서 불러오기(에러 메시지 없이 로드되는지)
- 미리보기: 샘플 값 입력 → `formulas-evaluate` 결과 JSON 확인

## 주의사항(중요)
- 문자 인코딩: 반드시 UTF-8 한글로 작성/저장
  - VS Code 설정 권장:
    - `"files.encoding": "utf8"`
    - `"files.autoGuessEncoding": false`
    - `"files.eol": "\n"` (팀 정책에 맞게 선택)
  - 기존 파일에 모지바케(깨진 한글)가 섞여 있으면, UTF-8 한글로 정정하세요(이스케이프 `\uXXXX`는 피함)
- JSX 문자열/태그 문법: 따옴표/템플릿 문자열/태그 닫힘 엄수(최근 에러 원인)
- 저장소 반영: 현재 IPC와 로더/평가 엔진은 동작. UI 쪽은 최소 변경으로 점진적 확장 권장

## 파일 구조(관련)
- `src/shared/formulas.defaults.json`  기본값 JSON
- `src/shared/formulas.js`             기본값+오버라이드 병합 로더(CommonJS)
- `src/shared/evaluator.js`            경영/시공 점수 계산(절삭/최대 선택)
- `main.js`                           IPC 핸들러(포뮬러 로딩/저장/평가)
- `preload.js`                        `window.electronAPI` 노출
- `src/view/features/settings/pages/SettingsPage.jsx`  설정 화면(현 상태: 복구본)

## 다음 담당자 작업 가이드(요청)
- 자동협정 기능을 위한 발주처 협정기능 (50억미만공사) UI 구성 (LH)

## 인계 프롬프트(다음 세션에서 붙여넣기)
다음은 차후 세션에서 그대로 붙여넣어 사용할 인계 프롬프트입니다.

```
작업 목표: 설정 화면에 공통 모달 뼈대를 추가하고, “부채비율/유동비율/신용평가 기준 수정” 버튼으로 모달을 열 수 있게 하되, 당장은 안내 문구 + 저장/취소만 있는 최소 뼈대를 구현한다. 모든 한글/파일 인코딩은 UTF-8로 유지한다.

참고 파일:
- src/components/Modal.jsx (신규 생성)
- src/view/features/settings/pages/SettingsPage.jsx (최소 변경: import/상태/버튼/모달 렌더 추가)
- IPC/평가 로직은 이미 main.js/preload.js/src/shared/*.js 에 구현되어 있으니 건드리지 말 것

구현 조건:
- Modal.jsx는 오버레이/박스/제목/저장/취소 등 중복코드를 방지위해 공통 모달로 사용.
- SettingsPage에는 버튼 3개(부채비율/유동비율/신용평가/품질평가)만 추가하여 각각 모달을 연다
- JSX 문법 오류/문자열 미종료가 없도록 주의
- 한글 라벨/문구는 전부 UTF-8로 직접 표기(이스케이프 금지)

완료 후 확인:
- `#/settings` 진입 시 에러 없이 렌더
- LH 협정기능 UI 구현, 메뉴에 LH메뉴 추가
- 빌드/런타임 에러 없음
```

---

문의/이슈 메모
- AgreementsPage/SettingsPage 등 일부 라벨에 모지바케가 남아 있을 수 있음 → 화면 확인하며 UTF-8 한글로 교체 권장
- 시공점수/경영점수 절삭 규칙은 defaults에 반영되어 있음. 평가 엔진(evaluator.js) 연동 시 주의

(문서 끝)

