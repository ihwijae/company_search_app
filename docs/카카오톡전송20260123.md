# 카카오톡 전송 기능 작업 정리 (2026-01-23)

## 목표
협정문자 생성 후 담당자별 카카오톡 채팅방으로 자동 전송하는 기능 추가.

---

## UI/기능 구현 내용

### 1) 카카오톡 전송 페이지
- 경로: `src/view/features/kakao/pages/KakaoSendPage.jsx`
- 라우팅: `#/kakao-send`
- 사이드바 메뉴: `카카오전송` 추가
- 레이아웃 구성
  - 좌측: 협정문자 입력 + 문자 분리 버튼
  - 우측: 업체별 담당자 목록 (자동매칭, 전송 대상 관리)

### 2) 담당자 카톡방 설정 (모달)
- 모달에서 담당자별 채팅방 설정 가능
- 채팅 타입 추가: **친구 / 채팅 / 오픈채팅**
- 기본값은 **선택 없음**
- 저장은 `electronAPI.stateSave` 기반

저장 키:
- `kakaoRoomSettings`

### 3) 담당자 자동매칭
- 문자 분리 시 업체명 추출
  - `%` 지분 / 사업자번호 제거
  - `(주)`는 유지
- DB 조회: `electronAPI.searchManyCompanies`
- 업체명 필드 `검색된 회사` 포함
- 후보 데이터에서 `extractManagerNames`로 담당자 추출 후
  담당자 카톡방 설정에 등록된 이름과 매칭

### 4) 담당자별 메시지 편집
- 우측 리스트에서 개별 메시지 편집 가능
- 기본 메시지 + 담당자 전용 메시지 오버라이드
- 템플릿 추가
  - [협정 정정]
  - [협정 취소]
    - 마지막 문구 자동 변경: `협정 취소 부탁드립니다.`
    - 하단에 `사유:` 자동 추가

### 5) 전송 제외/제거
- 담당자 선택값: 없음 / 제외
  - 없음/제외는 전송되지 않음
- 업체 목록에서 개별 제거 가능

---

## 카카오톡 자동전송 구현

### 1) 자동 전송 서비스
- 파일: `src/main/features/kakao/kakaoAutomation.js`
- PowerShell + Win32 API 핸들 제어 방식
- 카카오톡 메인창/채팅리스트/검색창/입력창 핸들 직접 접근
- SendKeys 기반 방식에서 핸들 기반으로 전환

핵심 흐름:
1. 카카오톡 메인창 핸들 찾기
2. 채팅 타입에 따라 리스트 선택
   - friend → ContactListView
   - chat/open → ChatRoomListView
3. 검색창(Edit)에 방 이름 입력 후 Enter
4. 채팅방 창 핸들 찾기 → RichEdit50W에 메시지 입력 → Enter 전송

### 2) IPC 연결
- main: `kakao:send-batch`
- preload: `electronAPI.kakao.sendBatch`

### 3) 전송 버튼 동작
- `카카오톡 전송` 버튼 → 확인창 → 전송 진행
- 전송 중 로딩 표시
- 완료 후 성공/실패 건수 토스트 표시

---

## 현재 상태 (중요)

- **카카오톡 전송 기능은 아직 테스트 완료되지 않음**
- 이전에는 `OnlineMainView`를 찾지 못하는 오류 발생
- 개선점:
  - OnlineMainView를 찾지 못할 경우 메인창을 fallback
  - 채팅 타입 선택 필수화 (친구/채팅/오픈채팅)

⚠️ 다음 세션에서 실제 카카오톡 실행 상태에서 전송 테스트 필요

---

## 변경된 주요 파일 목록

### 렌더러
- `src/view/features/kakao/pages/KakaoSendPage.jsx`
- `src/components/Sidebar.jsx` (카카오 메뉴 추가)
- `src/App.jsx` (라우팅 추가)

### 메인 프로세스
- `src/main/features/kakao/kakaoAutomation.js` (신규)
- `main.js` (IPC 등록)
- `preload.js` (kakao API 노출)

---

## 테스트 필요 사항

1. 카카오톡 실행 상태에서 실제 전송 동작 확인
2. 채팅 타입별로 리스트 전환 정상 여부 확인
3. 채팅방 검색 후 메시지 입력 정상 여부 확인
4. 실패 로그 시 원인 메시지 확인

---

## 참고
- 매크로 참고 문서: `docs/엑셀카카오톡매크로.md`
- 매크로 내부 함수: `docs/mod_fx.md`, `docs/mod_main.md`

